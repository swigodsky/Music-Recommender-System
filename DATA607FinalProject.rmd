---
title: "DATA 607 Final Project: Prediction Systems"
author: "Jagruti Salao and Sarah Wigodsky"
date: "`r Sys.Date()`"
output: ioslides_presentation

---
##Introduction
We will be using data from kaggle.com and participating in a current competition to create a better music recommendation system. The goal is to predict the chances of a user listening to a song within a month of the listener's first observable listening event.  Since people listen to many different types of music, it is hard to predict what song a person will want to listen to repeatedly.  Through kaggle KKBOX, Asia's leading music streaming service, a training data set with information about songs and listeners is provided. \n\
\n\
Target = 1 refers to a listener who listened to a song within a month of the first observed listening event \n\
\n\
Target = 0 refers to a listener who does not listen to the song again within a month of first hearing it

##Loading Libraries 
```{r,echo = TRUE, message = FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(reshape2)
library(tidyr)
library(stringr)
library(rpart)
library(RColorBrewer)
library(rpart.plot)
library(rattle)
```


##Loading Tables
- Load the following csv tables
- Members
- Songs
- Extra song information
- Training data set: Broken into components - to build the prediction model and test it against known target values
- Testing data set

```{r ,echo = FALSE}
#Loading Members Table
members <- read.csv("https://raw.githubusercontent.com/swigodsky/Music-Recommender-System/master/members.csv", stringsAsFactors = FALSE)
members <- members[1:10000,]
colnames(members) <- c("user_id", "city", "age", "gender", "registration_method", "registration_time", "expiration_date")
members$age <- gsub(0, NA, members$age) #replace age that is recorded as zero with NA
```


```{r,echo = FALSE}
#Loading Extra Song Info 
song_extra_info <- read.csv("https://raw.githubusercontent.com/swigodsky/Music-Recommender-System/master/song_extra_infob.csv",header=TRUE, stringsAsFactors=FALSE)
song_extra_info <- song_extra_info[1:4000,]
```


```{r,echo = FALSE}
#Loading Song Data Table
songs <- read.csv("https://raw.githubusercontent.com/swigodsky/Music-Recommender-System/master/songsd.csv", header=FALSE, stringsAsFactors = FALSE)

#, sep=",", header=FALSE, stringsAsFactors=FALSE, fileEncoding="latin1")
names(songs) = as.character(unlist(songs[1,]))
songs <- songs[-1,]
songs<-songs[1:10000,]
colnames(songs) <- c("song_id", "song_length", "genre_id", "artist_name", "composer", "lyricist", "language")
```


```{r,echo = FALSE}
#Loading Test Data - This Is Used For Submission To Kaggle
testdata <- read.csv("https://raw.githubusercontent.com/swigodsky/Music-Recommender-System/master/test.csv", stringsAsFactors = FALSE)
testdata <-testdata[1:4000,]
colnames(testdata) <- c("row_id", "user_id", "song_id", "system_tab", "layout_seen", "entry_source")
```

```{r,echo = FALSE}
#Loading Training Data - This is Used To Build and Test The Prediction Model
trainingdata <- read.csv("https://raw.githubusercontent.com/swigodsky/Music-Recommender-System/master/trainb.csv", stringsAsFactors = FALSE)

testwithtargetknown <-trainingdata[6001:8000,] #this data frame will be used to test our model
colnames(testwithtargetknown) <- c("user_id", "song_id", "system_tab", "layout_seen", "entry_source", "target")

trainingdata <-trainingdata[1:6000,]
colnames(trainingdata) <- c("user_id", "song_id", "system_tab", "layout_seen", "entry_source", "target")
```

## Merge Training Sets
```{r,echo = TRUE}
merger1 <- merge(trainingdata,songs,"song_id", all.x = TRUE)  
#all.x=TRUE gives left outer join
merger_train <- merge(merger1,members,"user_id", all.x = TRUE)

merger2 <- merge(testwithtargetknown,songs, by = "song_id", all.x=TRUE)  
merger_train2 <- merge(merger2,members, by = "user_id", all.x=TRUE)
```


##View Merged Training Data Set
```{r viewdata, echo=TRUE}
knitr::kable(head(merger_train))
```

##Merge Test sets
```{r,echo = TRUE}
merger3 <- merge.data.frame(testdata,songs,by = "song_id", all.x = TRUE)
merger_test <- merge.data.frame(merger3,members,by = "user_id", all.x = TRUE)
```

##Bar Graph to Show The Number of Listeners By Target Value
```{r,echo = TRUE}
ggplot(merger_train,aes(x= target))+ theme_bw(base_size = 16) + theme(axis.text.x=element_text(angle=90,hjust=1)) + geom_bar(colour = "purple")
```


##Considering The Proportion of Users Who Listen to a Song More Than Once Within One Month of First Hearing It - Target = 1
```{r,eval=TRUE, echo = TRUE}
prop.table(table(merger_train$target))
```

This shows that 78.73% of listeners listened to songs within a month of first hearing it.  This means we can assume that most listeners will have a target of 1.  

##Beginning To Build The Model By Setting the Target for Every Listener in the Test Group Equal to 1
```{r,echo = TRUE}
merger_test$target <- rep(1,4000)
merger_train2$targetguess <- rep(1, 2000)
```

## Gender - target model
```{r,echo = TRUE}
prop.table(table(merger_train$gender, merger_train$target),1)
```

77.83% of women who listened to a song, listened to it a second time.  74.07% of men who listened to a song, listened to it a second time.  There is not a signficant difference between women and men being a recurrent listener.

##system Tab - target model
```{r,echo = TRUE}
prop.table(table(merger_train$system_tab, merger_train$target),1)
```
The system tab is the name of the tab where the event was triggered. System tabs are used to categorize KKBOX mobile apps functions. The target is zero for 75.80% of people whose system tab is radio and 63.04% of the people whose system tab is listen with.  System tab will be helpful for making predictions.

##Setting the Target to 0 for system_tab=radio and system_tab=listen with
```{r testwithsystemtab, eval=TRUE}
merger_test$target[merger_test$system_tab=='radio'|merger_test$system_tab=='listen with'] <- 0

merger_train2$targetguess[merger_train2$system_tab=='radio'|merger_train2$system_tab=='listen with'] <- 0
```

##Age - Target Model
```{r age, eval=TRUE}
merger_train$younger <- 0
merger_train$younger[merger_train$age < 30] <-1
prop.table(table(merger_train$younger, merger_train$target),1)
```
Different age cutoffs were tested, and at every age, the percentage of people who repeatedly listened to a song was approximately the same.  74% of people below and 79% of people above 30 years old listened to a song again within one month of first hearing it.

##Gender and System Tab - Target Model
```{r gendersystemtab, eval=TRUE}
aggregate(target ~ system_tab + gender, data=merger_train, FUN=function(x) {sum(x)/length(x)})
```

There are a number of helpful predictions that can be make based on this data.  31.57% of females and 20% of males with a system tab of radio had a target of 1.  37.50% of females and 0% of males with a system tab of 'listen with' had a target of 1, but 71% of people whose gender was not listed had a target of 1 with that system tab.  90% of females and 17% of males with the search system tab had a target of 1.

##Adjusting the Prediction to take into account listen with and female, male and search
```{r testgenderandsystemtab, eval=TRUE, echo=TRUE}
merger_test$target[is.na(merger_test$gender) & merger_test$system_tab=='listen with'] <- 1
merger_test$target[merger_test$gender=='male'& merger_test$system_tab=='search'] <- 0

merger_train2$targetguess[is.na(merger_train2$gender) & merger_train2$system_tab=='listen with'] <- 1
merger_train2$targetguess[merger_train2$gender=='male'& merger_train2$system_tab=='search'] <- 0
```

##Comparing the Target to Our Guess of the Target
```{r checking-guess, eval=TRUE, echo=TRUE}
(sum(merger_train2$target == merger_train2$targetguess))/2000
```

The target is correctly predicted 79.90% of the time.


##Decision Tree
```{r decisiontree, eval=TRUE, echo=TRUE}
fit <- rpart(target ~  gender + system_tab + entry_source, data=merger_train, method="class")
fancyRpartPlot(fit)
```


##Using the Decision Tree to Predict the Target Value
```{r using-decision-tree-to-predict, eval = TRUE, echo=TRUE}
Prediction <- predict(fit, merger_train2, type = "class")
merger_train2$predict <- Prediction
(sum(merger_train2$target == merger_train2$predict))/2000
```

Using the decision tree, the target was predicted 80.30% of the time.


##Writing the Prediction to a File
```{r finaldataset, eval=TRUE}
#submit <- data.frame(user_id = merger_test$user_id, target = merger_test$target)
#write.csv(submit, file = "music.csv", row.names = FALSE)
```

##Challenges
- Using Very Large Data Sets
- Missing Data
- Wanting to Sort By Song Or Listener, but Having Too Many Different Options

##Conclusions
- Entry Source and System Tab were the most useful predictors for determining whether a listener will listen to a song again within a month of first hearing it
- The Decision Tree is easy To create in R and very useful for creating a predictive model
- Working with a data set through kaggle was a positive experience because there were so many resources on the site itself about recommender systems
